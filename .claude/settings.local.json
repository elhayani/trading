{
  "permissions": {
    "allow": [
      "Bash(unzip:*)",
      "Bash(python3:*)",
      "Bash(ls:*)",
      "Bash(find:*)",
      "Bash(zip:*)",
      "Bash(pkill:*)",
      "Bash(grep:*)",
      "Bash(while ps aux)",
      "Bash(done)",
      "Bash(./scripts/deploy.sh)",
      "Bash(tee -a ~/Trading/indices_deploy_v61.log)",
      "Bash(tee:*)",
      "Bash(./deploy.sh:*)",
      "Bash(chmod:*)",
      "Bash(yes:*)",
      "Bash(./cleanup_project.sh:*)",
      "Bash(./test_2022.sh:*)",
      "Bash(aws s3 ls:*)",
      "Bash(aws s3 cp:*)",
      "Bash(/tmp/monitor_v62_final.sh << 'EOF'\n#!/bin/bash\necho \"üîç MONITORING BACKTEST V6.2 FINAL\"\necho \"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\"\nsleep 10\n\nwhile true; do\n    clear\n    echo \"‚è∞ $\\(date '+%H:%M:%S'\\) - Backtest en cours...\"\n    echo \"‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\"\n    \n    # Check if still running\n    if ! pgrep -f \"run_test_v2.py.*Indices.*GSPC\" > /dev/null; then\n        echo \"‚úÖ BACKTEST TERMIN√â!\"\n        echo \"\"\n        echo \"üìä Analyse des r√©sultats en cours...\"\n        break\n    fi\n    \n    # Show recent activity\n    if [ -f \"backtest_indices_v62_FINAL_WITH_SIZING_FIX.log\" ]; then\n        echo \"\"\n        echo \"üìà Activit√© r√©cente:\"\n        tail -8 backtest_indices_v62_FINAL_WITH_SIZING_FIX.log | grep -E \"BUY|SELL|Portfolio|Test complete\" | tail -5\n    fi\n    \n    sleep 15\ndone\nEOF)",
      "Bash(/tmp/monitor_v62_final.sh)",
      "Bash(if [ -f \"backtest_indices_v62_FINAL_WITH_SIZING_FIX.log\" ])",
      "Bash(then)",
      "Bash(else)",
      "Bash(fi)",
      "Bash(run_test_force_yfinance.py << 'EOFPYTHON'\n# Copie de run_test_v2.py mais force YFinance au lieu de S3\nimport sys\nsys.path.insert\\(0, '/Users/zakaria/Trading/Systeme_Test_Bedrock'\\)\nfrom run_test_v2 import *\n\n# Patch pour forcer YFinance\noriginal_fetch = fetch_market_data_with_fallback\n\ndef fetch_market_data_with_fallback_FORCE_YF\\(symbol, days, offset_days=0\\):\n    \"\"\"Force YFinance m√™me si S3 a des donn√©es\"\"\"\n    logger.info\\(\"üîÑ FORCING YFINANCE \\(ignoring S3\\)\"\\)\n    \n    # Skip S3, go directly to fallback\n    loader = S3Loader\\(\\)\n    \n    # Check if crypto\n    is_crypto = '/' in symbol or symbol in ['BTC-USD', 'ETH-USD', 'SOL-USD', 'BTCUSDT', 'ETHUSDT']\n    \n    if is_crypto:\n        logger.info\\(f\"ü™ô Crypto detected, using Binance API for {symbol}...\"\\)\n        try:\n            data = fetch_crypto_from_binance\\(symbol, days, offset_days\\)\n            if data:\n                upload_data_to_s3\\(loader, symbol, data\\)\n                return data\n        except Exception as e:\n            logger.warning\\(f\"Binance fallback failed: {e}\"\\)\n    \n    # YFinance fallback \\(same as original but forced\\)\n    logger.info\\(f\"‚ö†Ô∏è Forcing YFinance for {symbol}...\"\\)\n    try:\n        import yfinance as yf\n        from datetime import timedelta\n        \n        end_date = datetime.now\\(\\) - timedelta\\(days=offset_days\\)\n        start_date = end_date - timedelta\\(days=days + 5\\)\n        \n        is_index = symbol.startswith\\('^'\\)\n        \n        if days > 730:\n            interval = \"1d\"\n        elif is_index and days > 30:\n            interval = \"1d\"\n            logger.info\\(f\"üìà Index detected, using 1d interval\"\\)\n        else:\n            interval = \"1h\"\n        \n        logger.info\\(f\"Downloading YF data \\({interval}\\) for {symbol}...\"\\)\n        df = yf.download\\(symbol, start=start_date, end=end_date, interval=interval, progress=False\\)\n        \n        if df.empty and interval == \"1h\":\n             logger.warning\\(\"YF 1h Empty, trying 1d...\"\\)\n             df = yf.download\\(symbol, start=start_date, end=end_date, interval=\"1d\", progress=False\\)\n\n        if not df.empty:\n            import pandas as pd\n            formatted_data = []\n            for index, row in df.iterrows\\(\\):\n                try:\n                    ts = int\\(index.timestamp\\(\\) * 1000\\)\n                    op = float\\(row['Open'].iloc[0]\\) if isinstance\\(row['Open'], pd.Series\\) else float\\(row['Open']\\)\n                    hi = float\\(row['High'].iloc[0]\\) if isinstance\\(row['High'], pd.Series\\) else float\\(row['High']\\)\n                    lo = float\\(row['Low'].iloc[0]\\) if isinstance\\(row['Low'], pd.Series\\) else float\\(row['Low']\\)\n                    cl = float\\(row['Close'].iloc[0]\\) if isinstance\\(row['Close'], pd.Series\\) else float\\(row['Close']\\)\n                    vo = float\\(row['Volume'].iloc[0]\\) if isinstance\\(row['Volume'], pd.Series\\) else float\\(row['Volume']\\)\n                    formatted_data.append\\([ts, op, hi, lo, cl, vo]\\)\n                except:\n                    ts = int\\(index.timestamp\\(\\) * 1000\\)\n                    formatted_data.append\\([ts, float\\(row['Open']\\), float\\(row['High']\\), float\\(row['Low']\\), float\\(row['Close']\\), float\\(row['Volume']\\)]\\)\n\n            logger.info\\(f\"Loaded {len\\(formatted_data\\)} candles from YFinance for {symbol}\"\\)\n            upload_data_to_s3\\(loader, symbol, formatted_data\\)\n            return formatted_data\n    except Exception as e:\n        logger.error\\(f\"YFinance Fallback failed: {e}\"\\)\n        \n    return []\n\n# Monkey patch\nimport run_test_v2\nrun_test_v2.fetch_market_data_with_fallback = fetch_market_data_with_fallback_FORCE_YF\n\nif __name__ == \"__main__\":\n    run_test\\('Indices', '^GSPC', 365, offset_days=0\\)\nEOFPYTHON)",
      "Bash(__NEW_LINE_54b19204a6890d55__ python3 run_test_force_yfinance.py)",
      "Bash(if pgrep:*)",
      "Bash(then echo '‚è≥ Backtest en cours...' tail -20 /private/tmp/claude-502/-Users-zakaria-Trading/tasks/b542c5d.output)",
      "Bash(pgrep:*)",
      "Bash(cdk deploy:*)"
    ]
  }
}
