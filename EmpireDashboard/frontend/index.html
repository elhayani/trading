<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Empire V10.9 - Performance Alpha</title>
    <!-- Favicon -->
    <link rel="icon"
        href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
        type="image/x-icon">
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {}
            }
        }
    </script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Moment.js for Time Axis -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1"></script>

    <style>
        :root {
            --bg-dark: #0F172A;
            --accent-blue: #3B82F6;
            --accent-purple: #8B5CF6;
            --glass-bg: rgba(30, 41, 59, 0.7);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: #E2E8F0;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            box-shadow: 0 0 10px currentColor;
        }

        .dot-green {
            background-color: #10B981;
            color: #10B981;
        }

        .dot-red {
            background-color: #EF4444;
            color: #EF4444;
        }

        .dot-amber {
            background-color: #F59E0B;
            color: #F59E0B;
        }

        .gradient-text {
            background: linear-gradient(135deg, #3B82F6 0%, #8B5CF6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        .live-pulse {
            animation: pulse-slow 2s infinite;
        }
    </style>
</head>

<body class="p-4 md:p-8">

    <!-- HEADER & STATUS -->
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-10">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <span
                    class="bg-blue-600/20 text-blue-400 px-3 py-1 rounded-full text-xs font-bold tracking-widest border border-blue-500/20">V10.9
                    SNIPER AGILE</span>
                <span class="status-dot dot-green live-pulse"></span>
                <span class="text-xs font-bold text-slate-500 uppercase tracking-tighter">System Live</span>
            </div>
            <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight text-white mb-2">Empire <span
                    class="gradient-text">Performance</span></h1>
            <p class="text-slate-400 max-w-lg">Advanced hybrid trading ecosystem. Real-time multi-asset intelligence &
                automation.</p>
        </div>

        <div class="flex gap-4">
            <div class="glass-panel p-4 flex flex-col items-center min-w-[140px]">
                <span class="text-slate-500 text-[10px] uppercase font-bold mb-1">Total Equity</span>
                <span id="totalEquity" class="text-2xl font-black text-white">$0.00</span>
                <span id="pnlTag" class="text-xs font-bold mt-1 text-green-400">+0.00%</span>
            </div>
            <div class="glass-panel p-4 flex flex-col items-center min-w-[140px]">
                <span class="text-slate-500 text-[10px] uppercase font-bold mb-1">Overall Winrate</span>
                <span id="winRate" class="text-2xl font-black text-blue-400">0%</span>
                <span id="totalTrades" class="text-[10px] font-bold mt-1 text-slate-500">0 TRADES</span>
            </div>
        </div>
    </div>

    <!-- MAIN GRID -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- LEFT: Allocations & Health -->
        <div class="lg:col-span-1 space-y-8">
            <div class="glass-panel p-6">
                <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                    üõ°Ô∏è System Health
                </h3>
                <div id="statusList" class="space-y-4">
                    <!-- Statuses injected here -->
                    <div class="animate-pulse flex space-y-4 flex-col">
                        <div class="h-12 bg-slate-800/50 rounded-lg"></div>
                        <div class="h-12 bg-slate-800/50 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <div class="glass-panel p-6">
                <h3 class="text-lg font-bold text-white mb-6 flex items-center justify-between">
                    <span>üìä Allocations</span>
                    <span class="text-[10px] text-slate-500 font-normal">Active Capital Distribution</span>
                </h3>
                <div id="allocationsContainer" class="space-y-6">
                    <!-- Allocations injected here -->
                </div>
            </div>
        </div>

        <!-- RIGHT: Live Chart -->
        <div class="lg:col-span-2">
            <div class="glass-panel p-6 h-full flex flex-col">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        üìà Equity Growth <span class="text-xs bg-slate-800 text-slate-400 px-2 py-0.5 rounded ml-2">Real
                            Time</span>
                    </h3>
                    <select id="yearSelect" onchange="fetchData()"
                        class="bg-slate-800 text-slate-300 text-xs rounded border border-slate-700 px-3 py-1.5 outline-none focus:border-blue-500">
                        <option value="2026">2026</option>
                        <option value="2025">2025</option>
                        <option value="ALL">All Time</option>
                    </select>
                </div>
                <div class="flex-grow min-h-[400px]">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- RECENT ACTIVITY TABLE -->
    <div class="max-w-7xl mx-auto mt-10">
        <div class="glass-panel p-6">
            <!-- TABS -->
            <div class="flex border-b border-slate-700 mb-6">
                <button onclick="switchTab('live')" id="tab-live"
                    class="px-6 py-3 font-bold text-sm transition-all border-b-2 border-blue-500 text-blue-400">
                    üî¥ LIVE POSITIONS (Binance)
                </button>
                <button onclick="switchTab('history')" id="tab-history"
                    class="px-6 py-3 font-bold text-sm transition-all border-b-2 border-transparent text-slate-500 hover:text-white">
                    üìú TRADE HISTORY (DynamoDB)
                </button>
                <button onclick="switchTab('skipped')" id="tab-skipped"
                    class="px-6 py-3 font-bold text-sm transition-all border-b-2 border-transparent text-slate-500 hover:text-white">
                    üö´ SKIPPED
                </button>
                <button onclick="switchTab('cloudwatch')" id="tab-cloudwatch"
                    class="px-6 py-3 font-bold text-sm transition-all border-b-2 border-transparent text-slate-500 hover:text-white">
                    ‚òÅÔ∏è CLOUDWATCH
                </button>
                <button onclick="switchTab('transactions')" id="tab-transactions"
                    class="px-6 py-3 font-bold text-sm transition-all border-b-2 border-transparent text-slate-500 hover:text-white">
                    üí∞ TRANSACTIONS
                </button>
            </div>

            <!-- SUB-TABS (Asset Class) -->
            <div class="flex gap-2 mb-6 overflow-x-auto pb-2">
                <button onclick="switchSubTab('ALL')" id="subtab-ALL"
                    class="px-4 py-2 text-xs font-bold rounded-full bg-blue-600 text-white transition-all shadow-lg shadow-blue-500/20 hover:bg-blue-500">
                    ALL
                </button>
                <button onclick="switchSubTab('Crypto')" id="subtab-Crypto"
                    class="px-4 py-2 text-xs font-bold rounded-full bg-slate-800 text-slate-400 border border-slate-700 hover:text-white hover:border-slate-500 transition-all">
                    ‚Çø Crypto
                </button>
                <button onclick="switchSubTab('Forex')" id="subtab-Forex"
                    class="px-4 py-2 text-xs font-bold rounded-full bg-slate-800 text-slate-400 border border-slate-700 hover:text-white hover:border-slate-500 transition-all">
                    üí± Forex
                </button>
                <button onclick="switchSubTab('Indices')" id="subtab-Indices"
                    class="px-4 py-2 text-xs font-bold rounded-full bg-slate-800 text-slate-400 border border-slate-700 hover:text-white hover:border-slate-500 transition-all">
                    üìà Indices
                </button>
                <button onclick="switchSubTab('Commodities')" id="subtab-Commodities"
                    class="px-4 py-2 text-xs font-bold rounded-full bg-slate-800 text-slate-400 border border-slate-700 hover:text-white hover:border-slate-500 transition-all">
                    üõ¢Ô∏è Commodities
                </button>
            </div>

            <!-- FILTERS (Hidden by default, shown in history) -->
            <div id="history-filters" class="hidden flex gap-3 mb-6">
                <!-- Month Filter -->
                <select id="monthFilter" onchange="applyFilters()"
                    class="bg-slate-800 text-slate-300 text-xs rounded border border-slate-700 px-3 py-1.5 focus:outline-none focus:border-blue-500">
                    <option value="ALL">All Months</option>
                    <option value="01">January</option>
                    <option value="02">February</option>
                    <option value="03">March</option>
                    <option value="04">April</option>
                    <option value="05">May</option>
                    <option value="06">June</option>
                    <option value="07">July</option>
                    <option value="08">August</option>
                    <option value="09">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>

                <!-- Status Filter -->
                <select id="statusFilter" onchange="applyFilters()"
                    class="bg-slate-800 text-slate-300 text-xs rounded border border-slate-700 px-3 py-1.5 focus:outline-none focus:border-blue-500">
                    <option value="ALL">All Status</option>
                    <option value="CLOSED">CLOSED</option>
                    <option value="SKIPPED">SKIPPED</option>
                </select>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead id="tradesTableHeader">
                        <!-- Header will be injected here -->
                    </thead>
                    <tbody id="tradesTableBody" class="text-sm text-slate-300">
                        <tr>
                            <td colspan="11" class="p-8 text-center text-slate-500">Waiting for data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const API_URL = "https://qhwqgpto9c.execute-api.eu-west-3.amazonaws.com/stats";
        const REFRESH_INTERVAL = 300000; // 5 min

        let chartInstance = null;
        let allTrades = []; // Store all trades for filtering
        let skippedTrades = []; // Last 50 skips
        let cloudwatchLogs = []; // Store system logs
        let transactionsData = []; // Binance income history
        let transactionsSummary = {}; // Summary by type
        let currentTab = 'live';
        let currentSubTab = 'ALL';

        function switchTab(tab) {
            currentTab = tab;

            const liveBtn = document.getElementById('tab-live');
            const histBtn = document.getElementById('tab-history');
            const skipBtn = document.getElementById('tab-skipped');
            const cwBtn = document.getElementById('tab-cloudwatch');
            const txBtn = document.getElementById('tab-transactions');
            const filters = document.getElementById('history-filters');

            [liveBtn, histBtn, skipBtn, cwBtn, txBtn].forEach(btn => {
                if (btn) btn.className = "px-6 py-3 font-bold text-sm transition-all border-b-2 border-transparent text-slate-500 hover:text-white";
            });

            const activeBtn = document.getElementById(`tab-${tab}`);
            if (activeBtn) activeBtn.className = "px-6 py-3 font-bold text-sm transition-all border-b-2 border-blue-500 text-blue-400";

            if (tab === 'live' || tab === 'transactions') {
                filters.classList.add('hidden');
            } else {
                filters.classList.remove('hidden');
            }

            if (tab === 'cloudwatch') {
                fetchCloudWatchLogs();
            } else if (tab === 'transactions') {
                fetchTransactions();
            } else {
                applyFilters();
            }
        }

        function switchSubTab(subTab) {
            currentSubTab = subTab;
            const tabs = ['ALL', 'Crypto', 'Forex', 'Indices', 'Commodities'];
            tabs.forEach(t => {
                const btn = document.getElementById(`subtab-${t}`);
                if (t === subTab) {
                    btn.className = "px-4 py-2 text-xs font-bold rounded-full bg-blue-600 text-white transition-all shadow-lg shadow-blue-500/20 hover:bg-blue-500";
                } else {
                    btn.className = "px-4 py-2 text-xs font-bold rounded-full bg-slate-800 text-slate-400 border border-slate-700 hover:text-white hover:border-slate-500 transition-all";
                }
            });
            applyFilters();
        }

        async function fetchData() {
            try {
                // Stabilized: Only fetch current year data by default
                const response = await fetch(API_URL);
                const data = await response.json();
                renderDashboard(data);
                fetchStatuses();
            } catch (error) {
                console.error("Error fetching data:", error);
                document.getElementById('totalEquity').innerText = "Offline";
            }
        }

        async function fetchCloudWatchLogs() {
            try {
                const response = await fetch(API_URL.replace('/stats', '/lambda-logs'));
                const data = await response.json();
                cloudwatchLogs = data.logs || [];
                updateTable([]);
            } catch (e) { console.error("CloudWatch fetch fail", e); }
        }

        async function fetchTransactions(days = 7) {
            try {
                const tbody = document.getElementById('tradesTableBody');
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500">Loading transactions from Binance...</td></tr>';
                const response = await fetch(API_URL.replace('/stats', `/transactions?days=${days}`));
                const data = await response.json();
                transactionsData = data.transactions || [];
                transactionsSummary = data.summary || {};
                updateTable([]);
            } catch (e) {
                console.error("Transactions fetch fail", e);
                const tbody = document.getElementById('tradesTableBody');
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-red-400">Failed to load transactions</td></tr>';
            }
        }

        async function fetchStatuses() {
            try {
                const response = await fetch(API_URL.replace('/stats', '/status'));
                const statuses = await response.json();
                renderStatuses(statuses);
            } catch (e) { console.error("Status fetch fail", e); }
        }

        function renderStatuses(statuses) {
            const list = document.getElementById('statusList');
            list.innerHTML = '';
            const systems = [
                { id: 'Crypto', label: 'Crypto (V4 Hybrid)' },
                { id: 'Forex', label: 'Forex (Trend)' },
                { id: 'Indices', label: 'Indices (Momentum)' },
                { id: 'Commodities', label: 'Gold & Oil (Trend)' }
            ];
            systems.forEach(sys => {
                const status = statuses[sys.id] || 'ACTIVE';
                const isPanic = status === 'PANIC';
                const html = `
                    <div class="flex items-center justify-between p-3 bg-slate-800/30 rounded-lg border border-slate-700/50">
                        <div class="flex items-center gap-3">
                            <span class="status-dot ${isPanic ? 'dot-red' : 'dot-green'}"></span>
                            <div>
                                <p class="text-sm font-bold text-white leading-none">${sys.id}</p>
                                <p class="text-[10px] text-slate-500 mt-1">${sys.label}</p>
                            </div>
                        </div>
                        <button onclick="togglePanic('${sys.id}', '${status}')" 
                            class="text-[10px] font-bold px-3 py-1.5 rounded transition-all duration-300 ${isPanic
                        ? 'bg-green-500/10 text-green-400 border border-green-500/30 hover:bg-green-500 hover:text-white'
                        : 'bg-red-500/10 text-red-500 border border-red-500/30 hover:bg-red-500 hover:text-white'}">
                            ${isPanic ? 'RE-ENABLE' : 'PANIC STOP'}
                        </button>
                    </div>
                `;
                list.innerHTML += html;
            });
        }

        async function togglePanic(system, currentStatus) {
            const newStatus = currentStatus === 'ACTIVE' ? 'PANIC' : 'ACTIVE';
            const action = newStatus === 'PANIC' ? 'STOP' : 'RE-ENABLE';
            if (!window.confirm(`Are you sure you want to ${action} the ${system} trading system?`)) return;
            try {
                await fetch(API_URL.replace('/stats', '/status'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ system, status: newStatus })
                });
                fetchStatuses();
            } catch (e) { alert("Failed to toggle status"); }
        }

        async function closeTrade(symbol, side, qty) {
            const actionText = side === 'SHORT' ? 'BUY TO CLOSE' : 'SELL TO CLOSE';
            if (!confirm(`‚ö†Ô∏è Voulez-vous vraiment ${actionText} la position ${symbol} (${qty}) ?`)) return;
            try {
                const response = await fetch(API_URL.replace('/stats', '/close-trade'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ symbol, side, qty })
                });
                if (response.ok) {
                    alert(`‚úÖ Position ferm√©e sur Binance !`);
                    location.reload();
                } else {
                    const result = await response.json();
                    alert("‚ùå Erreur: " + (result.error || 'Unknown error'));
                }
            } catch (err) { alert("‚ùå Erreur r√©seau: " + err.message); }
        }

        function renderDashboard(data) {
            const stats = data.stats || {};
            const equity = stats.current_equity || 1000.0;
            const pnl = stats.total_pnl || 0;
            document.getElementById('totalEquity').innerText = `$${equity.toFixed(2)}`;
            const pnlTag = document.getElementById('pnlTag');
            pnlTag.innerText = `${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} All Time`;
            pnlTag.className = `text-sm font-bold mt-1 ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            document.getElementById('winRate').innerText = `${stats.win_rate || 0}%`;
            document.getElementById('totalTrades').innerText = stats.total_trades || 0;
            updateChart(data.equity_curve || []);
            allTrades = data.recent_trades || [];
            skippedTrades = data.skipped_trades || [];
            applyFilters();
            updateAllocations(data.allocations || {}, stats.current_equity);
        }

        function getAssetClass(t) {
            // Priority 1: Check standard data from DynamoDB (Audit #V10.9)
            let ac = (t.AssetClass || '').toLowerCase().trim();
            const valid = ['crypto', 'forex', 'indices', 'commodities'];
            if (valid.includes(ac)) return ac;

            // Priority 2: Symbol-based pattern matching (Fallback)
            const s = (t.Pair || t.symbol || t.Symbol || '').toUpperCase();

            // Indices
            if (['SPX', 'NDX', 'US30', 'GSPC', 'IXIC', 'GER40', 'FTSE', 'DAX', 'VIX', 'CAC', 'NI225'].some(k => s.includes(k))) return 'indices';
            // Commodities
            if (['PAXG', 'XAG', 'XAU', 'OIL', 'WTI', 'USOIL', 'GOLD', 'SILVER', 'BRENT', 'XPT', 'XPD'].some(k => s.includes(k))) return 'commodities';
            // Forex (Exclude USDT pairs which are crypto)
            if (['EUR', 'GBP', 'AUD', 'JPY', 'CHF', 'CAD', 'SGD', 'NZD'].some(k => s.includes(k))) {
                if (!s.includes('USDT')) return 'forex';
            }

            // Priority 3: Default to Crypto
            return 'crypto';
        }

        function applyFilters() {
            const monthFilter = document.getElementById('monthFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            let filteredTrades = [];
            if (currentTab === 'live') {
                filteredTrades = allTrades.filter(t => (t.Status || '').toUpperCase() === 'OPEN');
                if (currentSubTab !== 'ALL') filteredTrades = filteredTrades.filter(t => getAssetClass(t) === currentSubTab.toLowerCase());
                filteredTrades.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            } else if (currentTab === 'history') {
                filteredTrades = allTrades.filter(t => (t.Status || '').toUpperCase() !== 'OPEN');
                if (currentSubTab !== 'ALL') filteredTrades = filteredTrades.filter(t => getAssetClass(t) === currentSubTab.toLowerCase());
                if (monthFilter !== 'ALL') {
                    filteredTrades = filteredTrades.filter(t => (t.Timestamp || '').substring(5, 7) === monthFilter);
                }
                if (statusFilter !== 'ALL') {
                    if (statusFilter === 'SKIPPED') {
                        filteredTrades = filteredTrades.filter(t => !['OPEN', 'CLOSED'].includes((t.Status || '').toUpperCase()));
                    } else {
                        filteredTrades = filteredTrades.filter(t => (t.Status || '').toUpperCase() === statusFilter);
                    }
                }
                filteredTrades.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
            }
            updateTable(filteredTrades);
        }

        function updateAllocations(allocations, totalEquity) {
            const container = document.getElementById('allocationsContainer');
            container.innerHTML = '';
            const assets = [
                { id: 'Crypto', color: 'bg-blue-500' },
                { id: 'Forex', color: 'bg-purple-500' },
                { id: 'Indices', color: 'bg-indigo-500' },
                { id: 'Commodities', color: 'bg-yellow-500' }
            ];
            assets.forEach(asset => {
                const data = allocations[asset.id] || { current: 0, pnl: 0, total: 0, open: 0, closed: 0, share_pct: 0 };
                const pnl = data.pnl;
                const current = data.current;
                let sharePct = data.share_pct || (totalEquity > 0 ? (current / totalEquity) * 100 : 0);
                const pnlLabel = pnl >= 0 ? `+${pnl.toFixed(0)}` : `${pnl.toFixed(0)}`;
                const html = `
                    <div>
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-slate-400 font-semibold">${asset.id}</span>
                            <div class="flex gap-2">
                                <span class="${pnl >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">$${current.toFixed(0)}</span>
                                <span class="text-slate-500 text-[10px] self-center">(${sharePct.toFixed(1)}%)</span>
                                <span class="text-slate-500">(${pnlLabel})</span>
                            </div>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-1 overflow-hidden mb-2">
                            <div class="${asset.color} h-1 rounded-full transition-all duration-1000" style="width: ${sharePct}%"></div>
                        </div>
                        <div class="flex gap-4 text-[10px] text-slate-500 uppercase font-bold tracking-tighter">
                            <span>Trades: <span class="text-white">${data.total}</span></span>
                            <span>Open: <span class="text-blue-400">${data.open}</span></span>
                            <span>Closed: <span class="text-slate-300">${data.closed}</span></span>
                        </div>
                    </div>
                `;
                container.innerHTML += html;
            });
        }

        function updateChart(dataPoints) {
            const ctx = document.getElementById('equityChart').getContext('2d');
            if (!dataPoints || dataPoints.length === 0) return;
            const chartData = dataPoints.map(pt => ({ x: new Date(pt.x), y: pt.y })).filter(pt => !isNaN(pt.x.getTime()));

            // Calculate dynamic min/max for better focus
            const values = chartData.map(pt => pt.y);
            const minVal = Math.min(...values);
            const maxVal = Math.max(...values);
            const buffer = (maxVal - minVal) * 0.1 || 5;

            if (chartInstance) {
                chartInstance.data.datasets[0].data = chartData;
                chartInstance.options.scales.y.min = Math.floor(minVal - buffer);
                chartInstance.options.scales.y.max = Math.ceil(maxVal + buffer);
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Empire Equity ($)',
                            data: chartData,
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748B' } },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.05)' },
                                ticks: { color: '#64748B' },
                                min: Math.floor(minVal - buffer),
                                max: Math.ceil(maxVal + buffer),
                                beginAtZero: false
                            }
                        }
                    }
                });
            }
        }

        function renderTransactions(tbody) {
            if (transactionsData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-500">No transactions found for this period.</td></tr>';
                return;
            }

            // Summary cards row
            const typeColors = {
                'REALIZED_PNL': { bg: 'bg-blue-500/10', border: 'border-blue-500/30', text: 'text-blue-400', icon: 'üìà' },
                'COMMISSION': { bg: 'bg-red-500/10', border: 'border-red-500/30', text: 'text-red-400', icon: 'üí∏' },
                'FUNDING_FEE': { bg: 'bg-yellow-500/10', border: 'border-yellow-500/30', text: 'text-yellow-400', icon: '‚è±Ô∏è' },
                'TRANSFER': { bg: 'bg-purple-500/10', border: 'border-purple-500/30', text: 'text-purple-400', icon: 'üîÑ' },
                'COIN_SWAP_DEPOSIT': { bg: 'bg-green-500/10', border: 'border-green-500/30', text: 'text-green-400', icon: 'üí±' },
                'COIN_SWAP_WITHDRAW': { bg: 'bg-orange-500/10', border: 'border-orange-500/30', text: 'text-orange-400', icon: 'üí±' }
            };
            const defaultStyle = { bg: 'bg-slate-500/10', border: 'border-slate-500/30', text: 'text-slate-400', icon: 'üìã' };

            // Build summary cards
            let summaryHtml = '<tr><td colspan="6" class="p-4"><div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">';
            const total = Object.values(transactionsSummary).reduce((a, b) => a + b, 0);
            summaryHtml += `<div class="bg-white/5 border border-white/10 rounded-xl p-4 text-center">
                <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">Net Total</div>
                <div class="text-xl font-black ${total >= 0 ? 'text-green-400' : 'text-red-400'}">${total >= 0 ? '+' : ''}${total.toFixed(2)}$</div>
                <div class="text-[10px] text-slate-600 mt-1">${transactionsData.length} transactions</div>
            </div>`;

            for (const [type, amount] of Object.entries(transactionsSummary).sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))) {
                const style = typeColors[type] || defaultStyle;
                summaryHtml += `<div class="${style.bg} border ${style.border} rounded-xl p-4 text-center">
                    <div class="text-[10px] text-slate-500 uppercase font-bold mb-1">${style.icon} ${type.replace(/_/g, ' ')}</div>
                    <div class="text-lg font-black ${amount >= 0 ? 'text-green-400' : 'text-red-400'}">${amount >= 0 ? '+' : ''}${amount.toFixed(4)}$</div>
                </div>`;
            }
            summaryHtml += '</div></td></tr>';

            // Table header for transactions
            summaryHtml += `<tr class="text-slate-500 text-[10px] uppercase tracking-wider border-b border-white/5">
                <th class="p-3 text-left font-semibold">Time</th>
                <th class="p-3 text-left font-semibold">Symbol</th>
                <th class="p-3 text-left font-semibold">Type</th>
                <th class="p-3 text-right font-semibold">Amount (USDT)</th>
                <th class="p-3 text-right font-semibold">Trade ID</th>
            </tr>`;
            tbody.innerHTML = summaryHtml;

            // Transaction rows
            transactionsData.forEach(tx => {
                const style = typeColors[tx.type] || defaultStyle;
                const amount = parseFloat(tx.amount);
                const amountClass = amount >= 0 ? 'text-green-400' : 'text-red-400';
                // Force UTC display for transactions
                const dateStr = tx.timestamp ? new Date(tx.timestamp).toISOString().replace('T', ' ').substring(0, 19) + ' UTC' : '-';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/3 hover:bg-white/3 transition-colors';
                tr.innerHTML = `
                    <td class="p-3 text-slate-500 font-mono text-xs whitespace-nowrap">${dateStr}</td>
                    <td class="p-3 font-bold text-white text-xs">${tx.symbol || '-'}</td>
                    <td class="p-3"><span class="px-2 py-0.5 rounded text-[10px] font-bold ${style.bg} ${style.text} border ${style.border}">${style.icon} ${tx.type.replace(/_/g, ' ')}</span></td>
                    <td class="p-3 text-right font-mono text-xs font-bold ${amountClass}">${amount >= 0 ? '+' : ''}${amount.toFixed(4)}</td>
                    <td class="p-3 text-right text-[10px] text-slate-600 font-mono">${tx.info || '-'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateTable(trades) {
            const tbody = document.getElementById('tradesTableBody');
            const thead = document.getElementById('tradesTableHeader');
            tbody.innerHTML = '';

            if (currentTab === 'live') {
                thead.innerHTML = `
                    <tr class="text-slate-500 text-[10px] uppercase tracking-wider border-b border-white/5 bg-white/2">
                        <th class="p-4 text-left font-semibold">Time (UTC)</th>
                        <th class="p-4 text-left font-semibold">Asset</th>
                        <th class="p-4 text-left font-semibold">Type</th>
                        <th class="p-4 text-left font-semibold">Size</th>
                        <th class="p-4 text-left font-semibold">Entry</th>
                        <th class="p-4 text-left font-semibold">Margin (xLev)</th>
                        <th class="p-4 text-right font-semibold">PnL %</th>
                        <th class="p-4 text-right font-semibold">PnL ‚Ç¨</th>
                        <th class="p-4 text-center font-semibold">Status</th>
                        <th class="p-4 text-left font-semibold">Reason</th>
                        <th class="p-4 text-right font-semibold">Action</th>
                    </tr>
                `;
            } else if (currentTab === 'cloudwatch') {
                thead.innerHTML = `
                    <tr class="text-slate-500 text-[10px] uppercase tracking-wider border-b border-white/5 bg-white/2">
                        <th class="p-4 text-left font-semibold">Time (UTC)</th>
                        <th class="p-4 text-left font-semibold">Source</th>
                        <th class="p-4 text-left font-semibold">Level</th>
                        <th class="p-4 text-left font-semibold w-[600px]">Message</th>
                        <th class="p-4 text-right font-semibold">Stream</th>
                    </tr>
                `;
            } else if (currentTab === 'skipped') {
                thead.innerHTML = `
                    <tr class="text-slate-500 text-[10px] uppercase tracking-wider border-b border-white/5 bg-white/2">
                        <th class="p-4 text-left font-semibold">Time (UTC)</th>
                        <th class="p-4 text-left font-semibold">Asset / Symbol</th>
                        <th class="p-4 text-left font-semibold">Reason for Skip</th>
                    </tr>
                `;
            } else if (currentTab === 'transactions') {
                thead.innerHTML = `
                    <tr class="text-slate-500 text-[10px] uppercase tracking-wider border-b border-white/5 bg-white/2">
                        <th class="p-4 text-left font-semibold" colspan="6">
                            <div class="flex items-center gap-4">
                                <span>üí∞ Binance Income Audit</span>
                                <select id="txDaysFilter" onchange="fetchTransactions(this.value)"
                                    class="bg-slate-800 text-slate-300 text-xs rounded border border-slate-700 px-2 py-1 focus:outline-none focus:border-blue-500">
                                    <option value="1">Last 24h</option>
                                    <option value="3">Last 3 days</option>
                                    <option value="7" selected>Last 7 days</option>
                                    <option value="14">Last 14 days</option>
                                    <option value="30">Last 30 days</option>
                                </select>
                            </div>
                        </th>
                    </tr>
                `;
                // Render summary cards + transactions table
                renderTransactions(tbody);
                return;
            } else {
                thead.innerHTML = `
                    <tr class="text-slate-500 text-[10px] uppercase tracking-wider border-b border-white/5 bg-white/2">
                        <th class="p-4 text-left font-semibold">Asset / Symbol</th>
                        <th class="p-4 text-left font-semibold">Reason / Signal</th>
                        <th class="p-4 text-center font-semibold">Trades Count</th>
                    </tr>
                `;
            }

            const dataToRender = currentTab === 'cloudwatch' ? cloudwatchLogs : (currentTab === 'skipped' ? skippedTrades : trades);
            if (dataToRender.length === 0) {
                const colSpan = currentTab === 'live' ? 11 : (currentTab === 'cloudwatch' ? 5 : (currentTab === 'skipped' ? 3 : 3));
                tbody.innerHTML = `<tr><td colspan="${colSpan}" class="p-8 text-center text-slate-500">No data recorded yet.</td></tr>`;
                return;
            }

            // ===== HISTORY TAB: Group by Asset + Reason (Audit #V11.3) =====
            if (currentTab === 'history') {
                const summaries = {};
                trades.forEach(t => {
                    const pair = t.Pair || t.Symbol || 'UNK';
                    // Check all possible reason field names (PascalCase, camelCase, lowercase)
                    const reason = t.Reason || t.ExitReason || t.AI_Reason || t.reason || t.exit_reason || 'Reason not provided';
                    const key = `${pair}||${reason}`;
                    if (!summaries[key]) summaries[key] = { pair, reason, count: 0, trade: t };
                    summaries[key].count++;
                });

                // Sort by count descending
                // Sort by count descending
                const sorted = Object.values(summaries).sort((a, b) => b.count - a.count);

                sorted.forEach(summary => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-800 hover:bg-slate-800/30 transition-colors";
                    const assetClass = getAssetClass(summary.trade);
                    const iconMap = { 'crypto': '‚Çø', 'forex': 'üí±', 'indices': 'üìà', 'commodities': 'üõ¢Ô∏è' };
                    const icon = iconMap[assetClass] || 'üìä';

                    tr.innerHTML = `
                        <td class="p-4 align-top font-bold text-white">
                             <div class="flex items-center gap-2">
                                <span class="bg-white/5 w-6 h-6 flex items-center justify-center rounded text-xs">${icon}</span>
                                <span class="tracking-tight">${summary.pair}</span>
                            </div>
                        </td>
                        <td class="p-4 align-top">
                            <div class="text-[10px] text-slate-400 leading-relaxed italic border-l-2 border-white/5 pl-3" style="max-width: 400px; overflow-wrap: break-word;">
                                ${summary.reason}
                            </div>
                        </td>
                        <td class="p-4 align-top text-center">
                            <span class="bg-blue-500/20 text-blue-400 px-3 py-1 rounded text-xs font-bold border border-blue-500/30">
                                ${summary.count}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                return; // Done with history tab
            }

            // ===== LIVE + CLOUDWATCH TABS =====
            dataToRender.forEach(trade => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-slate-800 hover:bg-slate-800/30 transition-colors";

                const assetClass = getAssetClass(trade);
                const iconMap = {
                    'crypto': '‚Çø',
                    'forex': 'üí±',
                    'indices': 'üìà',
                    'commodities': 'üõ¢Ô∏è'
                };
                const icon = iconMap[assetClass] || 'üìä';

                let dateStr = 'Unknown';
                try {
                    const d = new Date(trade.Timestamp);
                    if (!isNaN(d.getTime())) {
                        // Force UTC display (not local time)
                        dateStr = d.toISOString().replace('T', ' ').substring(0, 19) + ' UTC';
                    }
                } catch (e) { }

                if (currentTab === 'live') {
                    const status = (trade.Status || 'OPEN').toUpperCase();
                    const pair = trade.Pair || trade.Symbol || 'UNK';
                    const qty = parseFloat(trade.Size || 0);
                    const entryPrice = parseFloat(trade.EntryPrice || 0);
                    const currentPrice = parseFloat(trade.CurrentPrice || entryPrice);
                    const pnlVal = parseFloat(trade.PnL || 0);
                    const pnlPercent = entryPrice > 0 ? (trade.Type === 'SHORT' ? (entryPrice - currentPrice) / entryPrice * 100 : (currentPrice - entryPrice) / entryPrice * 100) : 0;

                    const margin = parseFloat(trade.Margin || (trade.Notional / (trade.Leverage || 1)) || 0) || 0;
                    const leverage = trade.Leverage || 1;
                    const reason = trade.AI_Reason || "Position r√©elle";

                    tr.innerHTML = `
                        <td class="p-4 align-top text-slate-500 font-mono text-[10px] whitespace-nowrap">${dateStr}</td>
                        <td class="p-4 align-top font-bold text-white">
                            <div class="flex items-center gap-2">
                                <span class="bg-white/5 w-6 h-6 flex items-center justify-center rounded text-xs">${icon}</span>
                                <span class="tracking-tight">${pair}</span>
                            </div>
                        </td>
                        <td class="p-4 align-top">
                            <span class="${trade.Type === 'LONG' || trade.Type === 'BUY' ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-red-500/10 text-red-400 border-red-500/20'} border px-2 py-0.5 rounded-full text-[9px] font-black tracking-tighter uppercase italic">
                                ${trade.Type || 'TRADE'}
                            </span>
                        </td>
                        <td class="p-4 align-top font-mono text-slate-300 text-sm tracking-tighter">${qty.toFixed(4)}</td>
                        <td class="p-4 align-top font-mono text-slate-400 text-sm tracking-tighter">$${entryPrice.toLocaleString()}</td>
                        <td class="p-4 align-top">
                             <div class="font-mono text-blue-300 text-sm tracking-tighter font-bold">$${margin.toFixed(2)}</div>
                             <div class="text-[9px] text-slate-500 font-black uppercase tracking-widest leading-none">LEV X${leverage}</div>
                        </td>
                        <td class="p-4 align-top text-right ${pnlVal >= 0 ? 'text-green-400' : 'text-red-400'} font-mono font-bold text-sm tracking-tighter">${pnlPercent.toFixed(2)}%</td>
                        <td class="p-4 align-top text-right ${pnlVal >= 0 ? 'text-green-400' : 'text-red-400'} font-mono font-bold text-sm tracking-tighter">‚Ç¨${pnlVal.toFixed(2)}</td>
                        <td class="p-4 align-top text-center">
                            <span class="bg-blue-500/10 text-blue-300 border border-blue-500/20 px-2 py-0.5 rounded text-[9px] font-black uppercase tracking-widest leading-none">${status}</span>
                        </td>
                        <td class="p-4 align-top">
                            <div class="text-[10px] text-slate-400 leading-relaxed italic border-l-2 border-white/5 pl-3" style="max-width: 250px; overflow-wrap: break-word;">
                                ${reason}
                            </div>
                        </td>
                        <td class="p-4 align-top text-right">
                            ${status === 'OPEN' ? `<button onclick="closeTrade('${pair}', '${trade.Type}', ${qty})" class="bg-blue-500 hover:bg-blue-400 text-white text-[9px] font-black px-3 py-1 rounded-sm shadow-lg shadow-blue-500/20 transition-all uppercase tracking-widest">CLOSE</button>` : ''}
                        </td>
                    `;
                } else if (currentTab === 'cloudwatch') {
                    const levelClass = trade.Type === 'ERROR' ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400';
                    tr.innerHTML = `
                        <td class="p-4 align-top text-slate-500 font-mono text-xs">${dateStr}</td>
                        <td class="p-4 align-top font-bold text-white">${trade.Source || 'SYSTEM'}</td>
                        <td class="p-4 align-top"><span class="${levelClass} px-2 py-1 rounded text-[10px] font-bold">${trade.Type || 'INFO'}</span></td>
                        <td class="p-4 align-top font-mono text-xs text-slate-300" style="max-width: 600px; overflow-wrap: break-word;">${trade.Message || '-'}</td>
                        <td class="p-4 align-top text-right text-[10px] text-slate-600 font-mono">${(trade.Stream || '').substring(0, 20)}</td>
                    `;
                } else if (currentTab === 'skipped') {
                    tr.innerHTML = `
                        <td class="p-4 align-top text-slate-500 font-mono text-xs whitespace-nowrap">${dateStr}</td>
                        <td class="p-4 align-top font-bold text-white">
                            <div class="flex items-center gap-2">
                                <span class="bg-white/5 w-6 h-6 flex items-center justify-center rounded text-xs">${icon}</span>
                                <span class="tracking-tight">${trade.Pair || trade.Symbol || 'UNK'}</span>
                            </div>
                        </td>
                        <td class="p-4 align-top">
                            <div class="text-[10px] text-slate-400 leading-relaxed italic border-l-2 border-white/5 pl-3" style="max-width: 600px; overflow-wrap: break-word;">
                                ${trade.AI_Reason || trade.Reason || trade.reason || 'Reason not provided'}
                            </div>
                        </td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        // INIT
        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL);
    </script>
</body>

</html>